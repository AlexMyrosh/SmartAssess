@model Presentation_Layer.ViewModels.UserExamAttemptViewModel

@{
    ViewData["Title"] = "Details";
}

<style>
    .centered {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        text-align: center;
        color: white;
    }

    .image-container {
        width: calc(100% + 24px);
        position: relative;
        overflow: hidden;
        margin-left: -12px;
        margin-right: -12px;
        margin-top: -16px;
    }

    .image-container img {
        filter: brightness(50%);
        width: 100vw;
        height: auto;
        object-fit: cover;
    }

    .order-card {
        color: #fff;
    }

    .bg-c-blue {
        background: linear-gradient(45deg,#4099ff,#73b4ff);
    }

    .bg-c-green {
        background: linear-gradient(45deg,#2ed8b6,#59e0c5);
    }

    .bg-c-yellow {
        background: linear-gradient(45deg,#FFB64D,#ffcb80);
    }

    .bg-c-pink {
        background: linear-gradient(45deg,#FF5370,#ff869a);
    }

    .bg-c-purple {
        background: linear-gradient(45deg, #9b59b6, #be90d4);
    }

    .bg-c-red {
        background: linear-gradient(45deg, #e74c3c, #f1948a);
    }

    .bg-c-orange {
        background: linear-gradient(45deg, #f39c12, #f9c6c9);
    }

    .bg-c-teal {
        background: linear-gradient(45deg, #1abc9c, #48c9b0);
    }

    .bg-c-indigo {
        background: linear-gradient(45deg, #34495e, #5d6d7e);
    }

    .bg-c-gray {
        background: linear-gradient(45deg, #7f8c8d, #bdc3c7);
    }

    .bg-c-brown {
        background: linear-gradient(45deg, #8e44ad, #a569bd);
    }

    .bg-c-cyan {
        background: linear-gradient(45deg, #00bcd4, #4dd0e1);
    }

    .card {
        border-radius: 5px;
        -webkit-box-shadow: 0 1px 2.94px 0.06px rgba(4,26,55,0.16);
        box-shadow: 0 1px 2.94px 0.06px rgba(4,26,55,0.16);
        border: none;
        margin-bottom: 30px;
        -webkit-transition: all 0.3s ease-in-out;
        transition: all 0.3s ease-in-out;
    }

    .card .card-block {
        padding: 25px;
    }

    .order-card i {
        font-size: 26px;
    }

    .f-left {
        float: left;
    }

    .f-right {
        float: right;
    }

    .card {
        display: flex;
        flex-direction: column;
    }

    .question {
        display: none;
        flex-direction: column;
    }

    .question.active {
        display: flex;
    }
</style>

<div class="container-fluid" style="padding: 0;">
    <div class="decor-default">
        <div class="contact">
            <div class="controls">
                <div class="image-container">
                    <img src="/images/banners/banner-1.png">
                    <div class="centered">
                        <h1 class="display-1" style="font-size: 6vw; font-weight: 400;">
                            @Model.Exam.Name
                        </h1>
                    </div>
                </div>
            </div>

            <div class="container" style="margin-top: 30px;">
                <div class="container mt-5">
                    <div class="container">
                        <div class="row">
                            <div class="col d-flex align-items-stretch">
                                <div class="card bg-c-indigo order-card flex-fill">
                                    <div class="card-body">
                                        <h2 class="m-b-20 text-center">Student name</h2>
                                        <h3 class="text-center"><span>@Model.User.FirstName @Model.User.LastName</span></h3>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col d-flex align-items-stretch">
                                <div class="card bg-c-indigo order-card flex-fill">
                                    <div class="card-body">
                                        <h2 class="m-b-20 text-center">Total grade</h2>
                                        <h3 class="text-center"><span><span id="totalGrade"></span></span></h3>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col d-flex align-items-stretch">
                                <div class="card bg-c-indigo order-card flex-fill">
                                    <div class="card-body">
                                        <h2 class="m-b-20 text-center">Result</h2>
                                        <h3 class="text-center"><span><span id="examResult"></span></span></h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form method="post" asp-action="Evaluation">
                    <div class="container" style="=margin-bottom: 30px;">
                        <div class="text-center">
                            <h1 class="display-4">Questions & Answers</h1>
                        </div>
                        @for (var i = 0; i < Model.UserAnswers.Count; i++)
                        {
                            <div class="card mb-3 question" id="question-@i" style="background-color: #f2f2f2; border-radius: 15px;">
                                <div class="card-body">
                                    <h5 class="card-title">Question @(i + 1) of @Model.Exam.Questions.Count</h5>
                                    <p class="card-text">@Model.UserAnswers[i].Question.QuestionText</p>
                                    <h5 class="card-title">Student's answer</h5>
                                    @if (string.IsNullOrWhiteSpace(Model.UserAnswers[i].AnswerText))
                                    {
                                        <p class="card-text"><em>No answer provided...</em></p>
                                    }
                                    else
                                    {
                                        <p class="card-text">@Model.UserAnswers[i].AnswerText</p>
                                    }

                                    <p>
                                        <strong>
                                            Grade (max grade - @Model.UserAnswers[i].Question.MaxGrade):
                                        </strong>
                                        <input min="0" max="@Model.UserAnswers[i].Question.MaxGrade" type="number" asp-for="@Model.UserAnswers[i].Grade" class="form-control grade" style="width: 80px;" />
                                    </p>

                                    <h5 class="card-title">Feedback</h5>
                                    <textarea rows="5" asp-for="@Model.UserAnswers[i].Feedback" class="form-control" placeholder="Write something about the student's' answer"></textarea>
                                </div>
                            </div>
                        }

                        <div class="container d-flex justify-content-center">
                            <nav aria-label="Page navigation example">
                                <ul class="pagination" id="pagination-nav">
                                    @for (int i = 0; i < Model.UserAnswers.Count; i++)
                                    {
                                        <li class="page-item me-2" data-page="@i">
                                            <a class="page-link" href="javascript:void(0);" onclick="showQuestion(@i)">
                                                @(i + 1)
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </nav>
                        </div>

                        <div>
                            <div class="text-center">
                                <h1 class="display-4">Overall exam feedback</h1>
                            </div>
                            @Html.TextAreaFor(model => model.Feedback, 10, 50, new { @class = "form-control", placeholder = "Write something about pros and cons of student's answers" })
                        </div>
                    </div>

                    <div class="text-center mb-3 mt-3">
                        @Html.HiddenFor(model => model.Id)
                        @Html.HiddenFor(model => model.Exam.Id)
                        <input type="submit" value="Save" class="btn btn-success" style="border-radius: 50px; font-size: 20px;" />
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    
    <script>
        // Select all input elements with the class 'grade'
        var inputs = document.querySelectorAll('.grade');

        // Function to adjust input values
        function adjustInputValue(input) {
            var min = parseInt(input.getAttribute('min')) || 0; // Default minimum to 0 if not set
            var max = parseInt(input.getAttribute('max')) || 100; // Default maximum to 100 if not set, you can change this

            // Force value to be within the min and max
            if (parseInt(input.value) < min) {
                input.value = min;
            } else if (parseInt(input.value) > max) {
                input.value = max;
            }
            }

            // Add event listeners to each input
            inputs.forEach(function(input) {
            input.addEventListener('input', function() {
                adjustInputValue(input);
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize to show the first question
            showQuestion(0);
        });

        function showQuestion(currentPage) {
            let allPageItems = document.querySelectorAll('#pagination-nav .page-item');
            let allQuestions = document.querySelectorAll(".question");

            // Update the active class on pagination items
            allPageItems.forEach((item, index) => {
                if (index === currentPage) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Display the corresponding question
            allQuestions.forEach(question => {
                if (question.id === `question-${currentPage}`) {
                    question.classList.add('active');
                } else {
                    question.classList.remove('active');
                }
            });
        }
    </script>

    <script>
        function calculateTotalGrade() {
            let totalGrade = 0;
            let examResult = 'Failed';
            $('.grade').each(function() {
                let grade = $(this).val();
                totalGrade += parseInt(grade, 10) || 0;
            });

            if (totalGrade >= @Model.Exam.MinimumPassGrade){
                examResult = 'Passed';
            }

            $('#totalGrade').text(totalGrade);
            $('#examResult').text(examResult);
        }

        calculateTotalGrade();
        $('.grade').change(calculateTotalGrade);
    </script>
}